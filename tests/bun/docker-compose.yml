version: '3'
services:
  postgres:
    image: "docker.io/library/postgres:15"
    command: "-c log_statement=all"
    healthcheck:
      test: "/usr/bin/pg_isready"
      timeout: "10s"
    user: "postgres:postgres"
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "password"
      POSTGRES_DB: "${PRISME_DATABASE:-prisme}"
    networks:
      default:
        aliases:
          - "postgres.localhost"

  clickhouse:
    image: "docker.io/clickhouse/clickhouse-server:23.9.1-alpine"
    ulimits:
      nofile: 262144
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1
    environment:
      CLICKHOUSE_USER: "clickhouse"
      CLICKHOUSE_PASSWORD: "password"
      CLICKHOUSE_DB: "${PRISME_DATABASE:-prisme}"
    networks:
      default:
        aliases:
          - "clickhouse.localhost"

  grafana:
    image: "docker.io/grafana/grafana-oss:10.3.1"
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1
      timeout: 30s
    user: "root:root"
    environment:
      # https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/
      GF_INSTALL_PLUGINS: "grafana-clickhouse-datasource"
      GF_LOG_LEVEL: "debug"
      # [server]
      GF_SERVER_HTTP_PORT: 3000
      # [feature_toggles]
      GF_FEATURE_TOGGLES_ENABLE: "publicDashboards"
      # [database]
      GF_DATABASE_TYPE: "sqlite3"
      GF_DATABASE_PATH: "/data/grafana.db"
      # [security]
      GF_SECURITY_SECRET_KEY: "grafana-secret-key"
      # [plugins]
      GF_PLUGINS_PLUGIN_ADMIN_ENABLED: false
      # [unified_alerting]
      GF_UNIFIED_ALERTING_ENABLED: false
      # [alerting]
      GF_ALERTING_ENABLED: false
      # [users]
      GF_USERS_ALLOW_SIGN_UP: true
      GF_USERS_AUTO_ASSIGN_ORG: true
      GF_USERS_ASSIGN_ORG_ROLE: editor
      GF_USERS_DEFAULT_THEME: "system"
      GF_USERS_EDITORS_CAN_ADMIN: true
      GF_USERS_HIDDEN_USER: "admin"
      # [auth]
      GF_AUTH_DISABLE_LOGIN_FORM: false
      GF_AUTH_DISABLE_SIGNOUT_MENU: true
      # [news]
      GF_NEWS_NEWS_FEED_ENABLED: false
      # [snapshots]
      GF_SNAPSHOTS_EXTERNAL_ENABLE: false
      GF_SNAPSHOTS_PUBLIC_MODE: false
    networks:
      default:
        aliases:
          - "grafana.localhost"
